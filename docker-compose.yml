services:
  nginx:
    build:
      context: ./build/nginx
      dockerfile: Dockerfile
    container_name: smart-guard-nginx
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - ./src:/var/www/html
    ports:
      - 8041:80
    restart: unless-stopped
    networks:
      - smart-guard

  php:
    build:
      context: ./build/php
      dockerfile: Dockerfile
    container_name: smart-guard-php
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
      - ./src:/var/www/html
    restart: unless-stopped
    networks:
      - smart-guard

  mysql:
    image: mysql:8.0
    container_name: smart-guard-mysql
    ports:
      - "8042:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
      - "/etc/timezone:/etc/timezone:ro"
      - "/etc/localtime:/etc/localtime:ro"
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: smart_guard
      MYSQL_USER: smart_guard
      MYSQL_PASSWORD: smart_guard_password
    restart: unless-stopped
    networks:
      - smart-guard

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: smart-guard-phpmyadmin
    restart: unless-stopped
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      MYSQL_ROOT_PASSWORD: root_password
    ports:
      - "8043:80"
    depends_on:
      - mysql
    networks:
      - smart-guard

  smart-guard-schedule-session:
    build: ./python
    container_name: smart-guard-python-schedule-session
    environment:
      MQTT_BROKER: ${MQTT_BROKER:-broker.emqx.io}
      MQTT_PORT: ${MQTT_PORT:-1883}
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
      MQTT_TOPICS: ${MQTT_TOPICS:-dJfmRURS5LaJtZ1NZAHX86A9uAk4LZ-smart-guard-rfid-response}
      API_BASE_URL: ${API_BASE_URL:-http://smart-guard-nginx/api}
      API_TOKEN: ${ADMIN_API_TOKEN:-58|FQntWTcX1ZSdKAp8ItJAhNBl9OBmYq2HYE6quIP605d554ef}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOCK_OPEN_DELAY: ${LOCK_OPEN_DELAY:-3}
    restart: unless-stopped
    volumes:
      - ./python/src:/app
    networks:
      - smart-guard

  smart-guard-fingerprint-schedule-session:
    build: ./python
    container_name: smart-guard-python-fingerprint-schedule-session
    command: python smart_guard_listener_fingerprint_schedule_session.py
    environment:
      MQTT_BROKER: ${MQTT_BROKER:-broker.emqx.io}
      MQTT_PORT: ${MQTT_PORT:-1883}
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
      MQTT_TOPICS: ${MQTT_TOPICS_FINGERPRINT:-dJfmRURS5LaJtZ1NZAHX86A9uAk4LZ-smart-guard-fingerprint-response}
      API_BASE_URL: ${API_BASE_URL:-http://smart-guard-nginx/api}
      API_TOKEN: ${ADMIN_API_TOKEN:-58|FQntWTcX1ZSdKAp8ItJAhNBl9OBmYq2HYE6quIP605d554ef}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOCK_OPEN_DELAY: ${LOCK_OPEN_DELAY:-3}
    restart: unless-stopped
    volumes:
      - ./python/src:/app
    networks:
      - smart-guard

  smart-guard-close-schedule-session:
    build: ./python
    container_name: smart-guard-python-close-schedule-session
    command: python smart_guard_listener_close_schedule_session.py
    environment:
      MQTT_BROKER: ${MQTT_BROKER:-broker.emqx.io}
      MQTT_PORT: ${MQTT_PORT:-1883}
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
      MQTT_TOPICS: ${MQTT_TOPICS_LCD_RESPONSE:-dJfmRURS5LaJtZ1NZAHX86A9uAk4LZ-smart-guard-lcd-response}
      MQTT_CLEAR_TOPIC: ${MQTT_CLEAR_TOPIC:-dJfmRURS5LaJtZ1NZAHX86A9uAk4LZ-smart-guard-lcd}
      API_BASE_URL: ${API_BASE_URL:-http://smart-guard-nginx/api}
      API_TOKEN: ${ADMIN_API_TOKEN:-58|FQntWTcX1ZSdKAp8ItJAhNBl9OBmYq2HYE6quIP605d554ef}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    restart: unless-stopped
    volumes:
      - ./python/src:/app
    networks:
      - smart-guard

  # smart-guard-student-attendance:
  #   build: ./python
  #   container_name: smart-guard-python-student-attendance
  #   command: python smart_guard_listener_student_attendance.py
  #   environment:
  #     MQTT_BROKER: ${MQTT_BROKER:-broker.emqx.io}
  #     MQTT_PORT: ${MQTT_PORT:-1883}
  #     MQTT_USERNAME: ${MQTT_USERNAME:-}
  #     MQTT_PASSWORD: ${MQTT_PASSWORD:-}
  #     MQTT_TOPIC: ${MQTT_TOPIC:-dJfmRURS5LaJtZ1NZAHX86A9uAk4LZ-smart-guard-rfid-response}
  #     API_BASE_URL: ${API_BASE_URL:-http://smart-guard-nginx/api}
  #     API_TOKEN: ${ADMIN_API_TOKEN:-58|FQntWTcX1ZSdKAp8ItJAhNBl9OBmYq2HYE6quIP605d554ef}
  #     LOG_LEVEL: ${LOG_LEVEL:-INFO}
  #   restart: unless-stopped
  #   volumes: 
  #     - ./python/src:/app
  #   networks:
  #     - smart-guard

  smart-guard-student-attendance-fingerprint:
    build: ./python
    container_name: smart-guard-python-student-attendance-fingerprint
    command: python smart_guard_listener_student_attendance_fingerprint.py
    environment:
      MQTT_BROKER: ${MQTT_BROKER:-broker.emqx.io}
      MQTT_PORT: ${MQTT_PORT:-1883}
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
      MQTT_TOPIC_FINGERPRINT: ${MQTT_TOPIC_FINGERPRINT:-dJfmRURS5LaJtZ1NZAHX86A9uAk4LZ-smart-guard-fingerprint-response}
      API_BASE_URL: ${API_BASE_URL:-http://smart-guard-nginx/api}
      API_TOKEN: ${ADMIN_API_TOKEN:-58|FQntWTcX1ZSdKAp8ItJAhNBl9OBmYq2HYE6quIP605d554ef}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOCK_OPEN_DELAY: ${LOCK_OPEN_DELAY:-3}
    restart: unless-stopped
    volumes:
      - ./python/src:/app
    networks:
      - smart-guard

networks:
  smart-guard:
    driver: bridge
    name: smart-guard
